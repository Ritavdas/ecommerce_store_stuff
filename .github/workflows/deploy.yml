name: Deploy to Vercel

on:
   push:
      branches: [main, master]
   workflow_run:
      workflows: ["Test Suite"]
      types: [completed]
      branches: [main, master]

jobs:
   deploy:
      name: Deploy
      runs-on: ubuntu-latest
      if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}

      steps:
         - uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: "20"
              cache: "npm"

         - name: Install dependencies
           run: npm ci

         - name: Run tests before deploy
           run: npm run test:unit
           env:
              CI: true

         - name: Build application
           run: npm run build
           env:
              NODE_ENV: production

         - name: Deploy to Vercel
           uses: amondnet/vercel-action@v25
           if: success()
           with:
              vercel-token: ${{ secrets.VERCEL_TOKEN }}
              vercel-org-id: ${{ secrets.ORG_ID }}
              vercel-project-id: ${{ secrets.PROJECT_ID }}
              vercel-args: "--prod"
           env:
              VERCEL_ORG_ID: ${{ secrets.ORG_ID }}
              VERCEL_PROJECT_ID: ${{ secrets.PROJECT_ID }}
